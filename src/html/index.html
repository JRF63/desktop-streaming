<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WebRTC Screen Duplicator Client</title>
    <style>
        #main-container {
            display: flex;
            flex-direction: column;
        }

        #video-container {
            display: flex;
            height: 50vh;
        }

        #controls {
            display: flex;
        }

        video {
            width: 100%;
        }

        video::-webkit-media-controls-panel {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="main-container">
        <div id="video-container">
            <video id="main-video"></video>
        </div>
        <div id="controls">
            <button id="start-button" onclick="startConnection()">Start</button>
            <button id="fullscreen-toggle" onclick="requestFullscreenVideo()" disabled>Fullscreen</button>
        </div>
    </div>
</body>

<script>
    const ws = new WebSocket("ws://" + location.host + "/ws");
    const pc = new RTCPeerConnection();
    const videoElement = document.getElementById("main-video");
    const videoContainer = document.getElementById("video-container");

    async function startConnection() {
        try {
            pc.addTransceiver("video", { direction: "recvonly" });
        } catch (err) {
            console.log(err);
        }
        document.getElementById("start-button").disabled = true;
        document.getElementById("fullscreen-toggle").disabled = false;
    }

    async function webSockedConnected() {
        while (true) {
            if (ws.readyState === WebSocket.OPEN) {
                return;
            }
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }

    async function sendOnWebSocket(type, data) {
        await webSockedConnected();
        const json = JSON.stringify({ type: type, data: data });
        ws.send(json);
    }

    async function requestFullscreenVideo() {
        await videoElement.requestFullscreen({ navigationUI: "hide" });
    }

    pc.onnegotiationneeded = async () => {
        try {
            await pc.setLocalDescription();
            await sendOnWebSocket("Sdp", pc.localDescription);
        } catch (err) {
            console.error(err);
        }
    };

    pc.oniceconnectionstatechange = async () => {
        if (pc.iceConnectionState === "failed") {
            pc.restartIce();
        }
    };

    pc.onicecandidate = async ({ candidate }) => {
        // candidate === null if there will no more ICE candidates
        if (candidate !== null) {
            try {
                await sendOnWebSocket("IceCandidate", candidate);
            } catch (err) {
                console.log(err);
            }
        }
    };

    pc.ontrack = async ({ track, streams }) => {
        videoElement.srcObject = streams[0];
        videoElement.autoplay = true;
        videoElement.controls = true;
        await requestFullscreenVideo();
    };

    // Implements the polite peer.
    // https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation#implementing_perfect_negotiation
    ws.onmessage = async (event) => {
        try {
            const message = JSON.parse(event.data);
            switch (message.type) {
                case "Sdp":
                    const description = message.data;
                    await pc.setRemoteDescription(new RTCSessionDescription(description));
                    if (description.type === "offer") {
                        await pc.setLocalDescription();
                        await sendOnWebSocket("Sdp", pc.localDescription);
                    }
                    break;
                case "IceCandidate":
                    try {
                        await pc.addIceCandidate(message.data);
                    } catch (err) {
                        throw err;
                    }
                    break;
                case "Bye":
                    pc.close();
                    break;
                default:
                    console.log("Unknown message type: " + message.type);
            }
        } catch (err) {
            console.error(err);
        }
    };

    videoElement.onfullscreenchange = (event) => {
        if (document.fullscreenElement) {
            // Entering fullscreen
        } else {
            // Exiting fullscreen
        }
    };
</script>

</html>